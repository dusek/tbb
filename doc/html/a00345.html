<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pipeline.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>pipeline.h</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">    Copyright 2005-2008 Intel Corporation.  All Rights Reserved.</span>
00003 <span class="comment"></span>
00004 <span class="comment">    The source code contained or described herein and all documents related</span>
00005 <span class="comment">    to the source code ("Material") are owned by Intel Corporation or its</span>
00006 <span class="comment">    suppliers or licensors.  Title to the Material remains with Intel</span>
00007 <span class="comment">    Corporation or its suppliers and licensors.  The Material is protected</span>
00008 <span class="comment">    by worldwide copyright laws and treaty provisions.  No part of the</span>
00009 <span class="comment">    Material may be used, copied, reproduced, modified, published, uploaded,</span>
00010 <span class="comment">    posted, transmitted, distributed, or disclosed in any way without</span>
00011 <span class="comment">    Intel's prior express written permission.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    No license under any patent, copyright, trade secret or other</span>
00014 <span class="comment">    intellectual property right is granted to or conferred upon you by</span>
00015 <span class="comment">    disclosure or delivery of the Materials, either expressly, by</span>
00016 <span class="comment">    implication, inducement, estoppel or otherwise.  Any license under such</span>
00017 <span class="comment">    intellectual property rights must be express and approved by Intel in</span>
00018 <span class="comment">    writing.</span>
00019 <span class="comment">*/</span>
00020 
00021 <span class="preprocessor">#ifndef __TBB_pipeline_H </span>
00022 <span class="preprocessor"></span><span class="preprocessor">#define __TBB_pipeline_H </span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#include "atomic.h"</span>
00025 <span class="preprocessor">#include "task.h"</span>
00026 <span class="preprocessor">#include &lt;cstddef&gt;</span>
00027 
00028 <span class="keyword">namespace </span>tbb {
00029 
00030 <span class="keyword">class </span>pipeline;
00031 <span class="keyword">class </span>filter;
00032 
00034 <span class="keyword">namespace </span>internal {
00035 
00036 <span class="comment">// The argument for PIPELINE_VERSION should be an integer between 2 and 9</span>
00037 <span class="preprocessor">#define __TBB_PIPELINE_VERSION(x) (unsigned char)(x-2)&lt;&lt;1</span>
00038 <span class="preprocessor"></span>
00039 <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> Token;
00040 <span class="keyword">typedef</span> <span class="keywordtype">long</span> tokendiff_t;
00041 <span class="keyword">class </span>stage_task;
00042 <span class="keyword">class </span>ordered_buffer;
00043 
00044 } <span class="comment">// namespace internal</span>
00046 <span class="comment"></span>
00048 
<a name="l00049"></a><a class="code" href="a00221.html">00049</a> <span class="keyword">class </span><a class="code" href="a00221.html">filter</a> {
00050 <span class="keyword">private</span>:
00052     <span class="keyword">static</span> <a class="code" href="a00221.html">filter</a>* not_in_pipeline() {<span class="keywordflow">return</span> reinterpret_cast&lt;filter*&gt;(internal::intptr(-1));}
00053     
00055     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> filter_is_serial = 0x1; 
00056 
00058     <span class="comment">// The bit was not set for parallel filters in TBB 2.1 and earlier,</span>
00059     <span class="comment">// but is_ordered() function always treats parallel filters as out of order</span>
00060     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> filter_is_out_of_order = 0x1&lt;&lt;4;  
00061 
00062     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> current_version = __TBB_PIPELINE_VERSION(3);
00063     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> version_mask = 0x7&lt;&lt;1; <span class="comment">// bits 1-3 are for version</span>
00064 <span class="keyword">public</span>:
<a name="l00065"></a><a class="code" href="a00221.html#w4">00065</a>     <span class="keyword">enum</span> mode {
00067         parallel = current_version | filter_is_out_of_order, 
00069         serial_in_order = current_version | filter_is_serial,
00071         serial_out_of_order = current_version | filter_is_serial | filter_is_out_of_order,
00073         serial = serial_in_order
00074     };
00075 <span class="keyword">protected</span>:
00076     <a class="code" href="a00221.html">filter</a>( <span class="keywordtype">bool</span> is_serial_ ) : 
00077         next_filter_in_pipeline(not_in_pipeline()),
00078         input_buffer(NULL),
00079         my_filter_mode(static_cast&lt;unsigned char&gt;(is_serial_ ? serial : parallel)),
00080         prev_filter_in_pipeline(not_in_pipeline()),
00081         my_pipeline(NULL)
00082     {}
00083     
00084     filter( mode filter_mode ) :
00085         next_filter_in_pipeline(not_in_pipeline()),
00086         input_buffer(NULL),
00087         my_filter_mode(static_cast&lt;unsigned char&gt;(filter_mode)),
00088         prev_filter_in_pipeline(not_in_pipeline()),
00089         my_pipeline(NULL)
00090     {}
00091 
00092 <span class="keyword">public</span>:
<a name="l00094"></a><a class="code" href="a00221.html#a0">00094</a>     <span class="keywordtype">bool</span> is_serial()<span class="keyword"> const </span>{
00095         <span class="keywordflow">return</span> bool( my_filter_mode &amp; filter_is_serial );
00096     }  
00097     
00098     <span class="comment">// ! True if filter must receive stream in order.</span>
00099     <span class="keywordtype">bool</span> is_ordered()<span class="keyword"> const </span>{
00100         <span class="keywordflow">return</span> (my_filter_mode &amp; (filter_is_out_of_order|filter_is_serial))==filter_is_serial;
00101     }
00102 
00104 
00105     <span class="keyword">virtual</span> <span class="keywordtype">void</span>* operator()( <span class="keywordtype">void</span>* item ) = 0;
00106 
00108 
00109     <span class="keyword">virtual</span> __TBB_EXPORTED_METHOD ~filter();
00110 
00111 <span class="keyword">private</span>:
00113     filter* next_filter_in_pipeline;
00114 
00116     internal::ordered_buffer* input_buffer;
00117 
00118     <span class="keyword">friend</span> <span class="keyword">class </span>internal::stage_task;
00119     <span class="keyword">friend</span> <span class="keyword">class </span>pipeline;
00120 
00122     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> my_filter_mode;
00123 
00125     filter* prev_filter_in_pipeline;
00126 
00128     pipeline* my_pipeline;
00129 };
00130 
00132 
<a name="l00133"></a><a class="code" href="a00240.html">00133</a> <span class="keyword">class </span><a class="code" href="a00240.html">pipeline</a> {
00134 <span class="keyword">public</span>:
00136     __TBB_EXPORTED_METHOD <a class="code" href="a00240.html">pipeline</a>();
00137 
00140     <span class="keyword">virtual</span> __TBB_EXPORTED_METHOD ~<a class="code" href="a00240.html">pipeline</a>();
00141 
00143     <span class="keywordtype">void</span> __TBB_EXPORTED_METHOD add_filter( <a class="code" href="a00221.html">filter</a>&amp; filter_ );
00144 
00146     <span class="keywordtype">void</span> __TBB_EXPORTED_METHOD run( size_t max_number_of_live_tokens );
00147 
00149     <span class="keywordtype">void</span> __TBB_EXPORTED_METHOD clear();
00150 
00151 <span class="keyword">private</span>:
00152     <span class="keyword">friend</span> <span class="keyword">class </span>internal::stage_task;
00153     <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="a00221.html">filter</a>;
00154 
00156     <a class="code" href="a00221.html">filter</a>* filter_list;
00157 
00159     <a class="code" href="a00221.html">filter</a>* filter_end;
00160 
00162     <a class="code" href="a00219.html">empty_task</a>* end_counter;
00163 
00165     <a class="code" href="a00195.html">atomic&lt;internal::Token&gt;</a> input_tokens;
00166 
00168     internal::Token token_counter;
00169 
00171     <span class="keywordtype">bool</span> end_of_input;
00172 
00174     <span class="keywordtype">void</span> remove_filter( <a class="code" href="a00221.html">filter</a>&amp; filter_ );
00175 
00177     <span class="keywordtype">void</span> __TBB_EXPORTED_METHOD inject_token( <a class="code" href="a00264.html">task</a>&amp; <span class="keyword">self</span> );
00178 };
00179 
00180 } <span class="comment">// tbb</span>
00181 
00182 <span class="preprocessor">#endif </span><span class="comment">/* __TBB_pipeline_H */</span>
</pre></div><hr>
<p></p>
Copyright &copy; 2005-2008 Intel Corporation.  All Rights Reserved.
<p></p>
Intel, Pentium, Intel Xeon, Itanium, Intel XScale and VTune are
registered trademarks or trademarks of Intel Corporation or its
subsidiaries in the United States and other countries.
<p></p>
* Other names and brands may be claimed as the property of others.
